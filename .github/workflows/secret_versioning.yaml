name: Update Version

on:
  push:
    branches:
      - feature/CB2-10972

jobs:
  update_version:
    permissions:
        id-token: write
        contents: write
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        role-to-assume: ${{ secrets.CVS_MGMT_AWS_ROLE }}
        aws-region: ${{ secrets.DVSA_AWS_REGION }}
        role-session-name: 'GHA_Versioning'

    - name : Get secret
      uses: aws-actions/aws-secretsmanager-get-secrets@v1
      with:
        secret-ids: develop/version
        parse-json-secrets: true

    - name: Get Current Version
      id: current_version
      run: |
        VERSION=$(aws secretsmanager get-secret-value --secret-id develop/version --region ${{ secrets.DVSA_AWS_REGION }} --output json | jq -r '.SecretString')
        echo "version=$VERSION" >> $GITHUB_STEP_SUMMARY

    - name: Calculate Next Version
      id: next_version
      run: |
        NEXT_VERSION=$(echo $VERSION | awk -F. '{$NF = $NF + 1;} 1' OFS=.)
        echo "next_version=$NEXT_VERSION" >> $GITHUB_ENV

    - name: Update Version in Secrets Manager
      run: |
        echo "NEXT_VERSION before update: $NEXT_VERSION"
        if [ -n "$NEXT_VERSION" ]; then
        aws secretsmanager put-secret-value --secret-id develop/version --version-stage AWSCURRENT --region ${{ secrets.DVSA_AWS_REGION}} --secret-string "$NEXT_VERSION"
        echo "Secret updated successfully."
        else
        echo "NEXT_VERSION is empty. Skipping update."
        fi



    
        

