name: Update Version

on:
  push:
    branches:
      - feature/CB2-10972

jobs:
  environment:
    name: ðŸ§¹ Prepare Environment
    runs-on: ubuntu-latest
    outputs: 
      aws-access-key-id: ${{ steps.creds.outputs.aws-access-key-id }}
      aws-secret-access-key: ${{ steps.creds.outputs.aws-secret-access-key }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Credentials
      id: creds
      uses: aws-actions/configure-aws-credentials@v3
      with:
        role-to-assume: ${{ secrets.CVS_MGMT_AWS_ROLE }}
        aws-region: ${{ secrets.DVSA_AWS_REGION }}
        role-session-name: 'GHA_Versioning'
        output-credentials: true

    - name : Get secret
      uses: aws-actions/aws-secretsmanager-get-secrets@v1
      with:
        secret-ids: develop/version
        parse-json-secrets: true

    - name: Get Current Version
      id: current_version
      run: |
        VERSION=$(aws secretsmanager get-secret-value --secret-id develop/version --region ${{ secrets.DVSA_AWS_REGION }} --output json | jq -r '.SecretString')
        echo "version=$VERSION" >> $GITHUB_ENV

    - name: Bump SemVer Version
      uses: dvsa/cvs-github-actions/version@develop
      with:
       bump: minor
       version-number: $VERSION
       number-type: semver

    - name: Upload Secrets
      id: get-secrets
      run: |
        secrets_json=$(aws secretsmanager put-secret-value --secret-id "develop/version" --version-stage AWSCURRENT --region ${{ secrets.DVSA_AWS_REGION }} --secret-string "$NEXT_VERSION" )
        echo "$NEXT_VERSION" >> $GITHUB_STEP_SUMMARY



    
        

