name: Update Version

on:
  push:
    branches:
      - feature/CB2-10972

jobs:
  update_version:
    permissions:
        id-token: write
        contents: write
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        role-to-assume: ${{ secrets.CVS_MGMT_AWS_ROLE }}
        aws-region: ${{ secrets.DVSA_AWS_REGION }}
        role-session-name: 'GHA_Versioning'

    - name : Get secret
      uses: aws-actions/aws-secretsmanager-get-secrets@v1
      with:
        secret-ids: develop/version
        parse-json-secrets: true

    - name: Get Current Version
      id: current_version
      run: |
        VERSION=$(aws secretsmanager get-secret-value --secret-id develop/version --region ${{ secrets.DVSA_AWS_REGION }} --output json | jq -r '.SecretString')
        echo "version=$VERSION" >> $GITHUB_ENV

    - name: Calculate Next Version
      id: next_version
      run: |
        # Implement your versioning logic here
        # For example, increment a version component
        NEXT_VERSION=$(echo $VERSION | awk -F. '{$NF = $NF + 1;} 1' OFS=.)
        echo "next_version=$NEXT_VERSION" >> $GITHUB_ENV

    - name: Upload Secrets
      id: get-secrets
      run: |
        secrets_json=$(aws secretsmanager put-secret-value --secret-id "develop/version" --version-stage AWSCURRENT --region ${{ secrets.DVSA_AWS_REGION }} --secret-string "$NEXT_VERSION" )
        echo "$NEXT_VERSION" >> $GITHUB_STEP_SUMMARY



    
        

